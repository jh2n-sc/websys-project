# Enable URL rewriting
RewriteEngine On

# Prevent directory listing
Options -Indexes

# Protect sensitive files
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Protect configuration files
<FilesMatch "^(config\\.php|composer\\.json|package\\.json|webpack\\.config\\.js|yarn\\.lock|package-lock\\.json)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Prevent access to .git directory
RedirectMatch 404 /\.git

# Set default character set
AddDefaultCharset UTF-8

# Set timezone
SetEnv TZ Asia/Manila

# Disable server signature
ServerSignature Off

# Set security headers
<IfModule mod_headers.c>
    # Protect against XSS attacks
    Header set X-XSS-Protection "1; mode=block"
    
    # Prevent MIME-type sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # Enable X-Frame-Options
    Header always append X-Frame-Options SAMEORIGIN
    
    # Enable HSTS
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Enable Content Security Policy
    Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://maps.googleapis.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' data: https://cdnjs.cloudflare.com; connect-src 'self' https://maps.googleapis.com;"
    
    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Prevent content type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Feature Policy
    Header always set Feature-Policy "geolocation 'self'; microphone 'none'; camera 'none'"
</IfModule>

# Enable compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Set cache control for static assets
<FilesMatch "\.(ico|pdf|flv|jpg|jpeg|png|gif|js|css|swf|woff|woff2|ttf|eot|svg)$">
    <IfModule mod_headers.c>
        Header set Cache-Control "max-age=31536000, public"
    </IfModule>
</FilesMatch>

# URL Rewriting for clean URLs
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    
    # Redirect to HTTPS if not already (skip for localhost)
    RewriteCond %{HTTPS} off
    RewriteCond %{HTTP_HOST} !^(localhost|127\.0\.0\.1)$ [NC]
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Remove trailing slashes
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)/$ /$1 [L,R=301]
    
    # Disable front controller routing to allow direct access to PHP pages
    # If you later add a router, you can restore a front controller rule here.
</IfModule>

## The blocks below were duplicated earlier; keeping only one set (above) to avoid header duplication.
